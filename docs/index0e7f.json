{"id":690,"date":"2010-02-24T12:51:01","date_gmt":"2010-02-24T03:51:01","guid":{"rendered":"http:\/\/blog.susumuis.info\/?p=690"},"modified":"2014-07-01T19:36:18","modified_gmt":"2014-07-01T10:36:18","slug":"twitter%e3%82%92%e6%90%ba%e5%b8%af%e3%83%a1%e3%83%bc%e3%83%ab%e3%81%ab%e8%bb%a2%e9%80%81%e3%81%99%e3%82%8bgae%e3%82%a2%e3%83%97%e3%83%aa","status":"publish","type":"post","link":"https:\/\/www.susumuis.info\/entry\/20100224\/1282103461","title":{"rendered":"twitter\u3092\u643a\u5e2f\u30e1\u30fc\u30eb\u306b\u8ee2\u9001\u3059\u308bGAE\u30a2\u30d7\u30ea"},"content":{"rendered":"<p>iPhone\u3082\u3001Android\u3082\u3001\u305d\u3082\u305d\u3082\u81ea\u5b85\u30cd\u30c3\u30c8\u74b0\u5883\u3082\u306a\u3044\u79c1\u306f\u3082\u3063\u3071\u3089\u3001\u643a\u5e2f\u3067Twitter\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002<\/p>\n\n<p>tmitter\uff08<a href=\"http:\/\/tmitter.org\/\">http:\/\/tmitter.org\/<\/a>\uff09\u3067\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u304c\u53d6\u5f97\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001GAE\u306e\u52c9\u5f37\u3082\u304b\u306d\u3066\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002<\/p>\n\n<pre class=\"code lang-java\" data-lang=\"java\" data-unlink><span class=\"synPreProc\">package<\/span> ishigami.twittermail;\n<span class=\"synPreProc\">import<\/span> java.io.IOException;\n<span class=\"synPreProc\">import<\/span> javax.servlet.http.HttpServlet;\n<span class=\"synPreProc\">import<\/span> javax.servlet.http.HttpServletRequest;\n<span class=\"synPreProc\">import<\/span> javax.servlet.http.HttpServletResponse;\n<span class=\"synPreProc\">import<\/span> com.google.appengine.api.datastore.DatastoreService;\n<span class=\"synPreProc\">import<\/span> com.google.appengine.api.datastore.DatastoreServiceFactory;\n<span class=\"synPreProc\">import<\/span> com.google.appengine.api.datastore.Entity;\n<span class=\"synPreProc\">import<\/span> com.google.appengine.api.datastore.EntityNotFoundException;\n<span class=\"synPreProc\">import<\/span> com.google.appengine.api.datastore.KeyFactory;\n<span class=\"synPreProc\">import<\/span> com.google.appengine.api.mail.MailServiceFactory;\n<span class=\"synPreProc\">import<\/span> com.google.appengine.api.mail.MailService.Message;\n<span class=\"synPreProc\">import<\/span> twitter4j.Paging;\n<span class=\"synPreProc\">import<\/span> twitter4j.ResponseList;\n<span class=\"synPreProc\">import<\/span> twitter4j.Status;\n<span class=\"synPreProc\">import<\/span> twitter4j.Twitter;\n<span class=\"synPreProc\">import<\/span> twitter4j.TwitterException;\n<span class=\"synPreProc\">import<\/span> twitter4j.TwitterFactory;\n<span class=\"synPreProc\">@SuppressWarnings<\/span>(<span class=\"synConstant\">\"serial\"<\/span>)\n<span class=\"synType\">public<\/span> <span class=\"synType\">class<\/span> TwitterMailServlet <span class=\"synType\">extends<\/span> HttpServlet {\n<span class=\"synComment\">\/\/ \u8a2d\u5b9a\u60c5\u5831<\/span>\n<span class=\"synType\">private<\/span> <span class=\"synType\">static<\/span> <span class=\"synType\">final<\/span> String SYSTEM_ADMIN_MAIL = <span class=\"synConstant\">\"XXXXXXXXXXXXXXXXXXXX\"<\/span>;\n<span class=\"synType\">private<\/span> <span class=\"synType\">static<\/span> <span class=\"synType\">final<\/span> String YOUR_MAIL = <span class=\"synConstant\">\"XXXXXXXXXXXXXXXXXXX\"<\/span>;\n<span class=\"synType\">private<\/span> <span class=\"synType\">static<\/span> <span class=\"synType\">final<\/span> String YOUR_MAIL_POST_ADDRESS = <span class=\"synConstant\">\"\"<\/span>;\n<span class=\"synType\">private<\/span> <span class=\"synType\">static<\/span> <span class=\"synType\">final<\/span> String TWITTER_ID = <span class=\"synConstant\">\"XXXXXXXXXXXXX\"<\/span>;\n<span class=\"synType\">private<\/span> <span class=\"synType\">static<\/span> <span class=\"synType\">final<\/span> String TWITTER_PW = <span class=\"synConstant\">\"XXXXXXXXXXXXX\"<\/span>;\n<span class=\"synType\">public<\/span> <span class=\"synType\">void<\/span> doGet(HttpServletRequest request, HttpServletResponse response) <span class=\"synType\">throws<\/span> IOException {\nString path = request.getRequestURI().substring(request.getContextPath().length());\n<span class=\"synStatement\">if<\/span> (path.equals(<span class=\"synConstant\">\"\/tl\"<\/span>) || path.equals(<span class=\"synConstant\">\"\/reply\"<\/span>)) {\nDatastoreService dataService = DatastoreServiceFactory.getDatastoreService();\nStringBuilder text = <span class=\"synStatement\">new<\/span> StringBuilder();\nTwitter twitter = <span class=\"synStatement\">new<\/span> TwitterFactory().getInstance(TWITTER_ID, TWITTER_PW);\n<span class=\"synStatement\">if<\/span> (path.equals(<span class=\"synConstant\">\"\/tl\"<\/span>)) {\n<span class=\"synComment\">\/\/ \u4fdd\u5b58\u3055\u308c\u305f\u6700\u65b0\u306eID\u3092\u53d6\u5f97<\/span>\n<span class=\"synType\">long<\/span> lastId = -<span class=\"synConstant\">1<\/span>;\n<span class=\"synStatement\">try<\/span> {\nEntity entity = dataService.get(KeyFactory.createKey(<span class=\"synConstant\">\"twitter\"<\/span>, <span class=\"synConstant\">\"timeline\"<\/span>));\nObject id = entity.getProperty(<span class=\"synConstant\">\"lastId\"<\/span>);\n<span class=\"synStatement\">if<\/span> (id != <span class=\"synConstant\">null<\/span>) {\nlastId = (Long) id;\n}\n} <span class=\"synStatement\">catch<\/span> (EntityNotFoundException e) {\n}\n<span class=\"synStatement\">try<\/span> {\nResponseList&lt;Status&gt; timeline = twitter.getHomeTimeline();\n<span class=\"synStatement\">for<\/span> (Status status : timeline) {\n<span class=\"synStatement\">if<\/span> (lastId == status.getId()) {\n<span class=\"synStatement\">break<\/span>;\n}\ntext.append(status.getUser().getScreenName() + <span class=\"synConstant\">\":\"<\/span> + status.getText() + <span class=\"synConstant\">\"<\/span><span class=\"synSpecial\">\\n<\/span><span class=\"synConstant\">\"<\/span>);\n}\n<span class=\"synComment\">\/\/ \u6700\u65b0\u306eID\u3092\u4fdd\u5b58<\/span>\n<span class=\"synType\">long<\/span> theLastId = timeline.get(<span class=\"synConstant\">0<\/span>).getId();\nEntity entity = <span class=\"synStatement\">new<\/span> Entity(<span class=\"synConstant\">\"twitter\"<\/span>, <span class=\"synConstant\">\"timeline\"<\/span>);\nentity.setProperty(<span class=\"synConstant\">\"lastId\"<\/span>, theLastId);\ndataService.put(entity);\n} <span class=\"synStatement\">catch<\/span> (TwitterException e) {\nresponse.setContentType(<span class=\"synConstant\">\"text\/plain\"<\/span>);\nresponse.setCharacterEncoding(<span class=\"synConstant\">\"UTF-8\"<\/span>);\nresponse.getWriter().println(<span class=\"synConstant\">\"twitter error\"<\/span> + e.getMessage());\n}\n} <span class=\"synStatement\">else<\/span> <span class=\"synStatement\">if<\/span> (path.equals(<span class=\"synConstant\">\"\/reply\"<\/span>)) {\n<span class=\"synComment\">\/\/ \u4fdd\u5b58\u3055\u308c\u305f\u6700\u65b0\u306eID\u3092\u53d6\u5f97<\/span>\n<span class=\"synType\">long<\/span> lastId = -<span class=\"synConstant\">1<\/span>;\n<span class=\"synStatement\">try<\/span> {\nEntity entity = dataService.get(KeyFactory.createKey(<span class=\"synConstant\">\"twitter\"<\/span>, <span class=\"synConstant\">\"reply\"<\/span>));\nObject id = entity.getProperty(<span class=\"synConstant\">\"lastId\"<\/span>);\n<span class=\"synStatement\">if<\/span> (id != <span class=\"synConstant\">null<\/span>) {\nlastId = (Long) id;\n}\n} <span class=\"synStatement\">catch<\/span> (EntityNotFoundException e) {\n}\n<span class=\"synStatement\">try<\/span> {\nResponseList&lt;Status&gt; mentions = twitter.getMentions(<span class=\"synStatement\">new<\/span> Paging(<span class=\"synConstant\">1<\/span>, <span class=\"synConstant\">8<\/span>));\n<span class=\"synStatement\">for<\/span> (Status status : mentions) {\n<span class=\"synStatement\">if<\/span> (lastId == status.getId()) {\n<span class=\"synStatement\">break<\/span>;\n}\ntext.append(status.getUser().getScreenName() + <span class=\"synConstant\">\":\"<\/span> + status.getText() + <span class=\"synConstant\">\"<\/span><span class=\"synSpecial\">\\n<\/span><span class=\"synConstant\">\"<\/span>);\n}\n<span class=\"synComment\">\/\/ \u6700\u65b0\u306eID\u3092\u4fdd\u5b58<\/span>\n<span class=\"synType\">long<\/span> theLastId = mentions.get(<span class=\"synConstant\">0<\/span>).getId();\nEntity entity = <span class=\"synStatement\">new<\/span> Entity(<span class=\"synConstant\">\"twitter\"<\/span>, <span class=\"synConstant\">\"reply\"<\/span>);\nentity.setProperty(<span class=\"synConstant\">\"lastId\"<\/span>, theLastId);\ndataService.put(entity);\n} <span class=\"synStatement\">catch<\/span> (TwitterException e) {\n<span class=\"synStatement\">throw<\/span> <span class=\"synStatement\">new<\/span> RuntimeException(e);\n}\n<span class=\"synStatement\">if<\/span> (text.length() &gt; <span class=\"synConstant\">0<\/span>) {\ntext.append(<span class=\"synConstant\">\"<\/span><span class=\"synSpecial\">\\n<\/span><span class=\"synConstant\">\"<\/span> + YOUR_MAIL_POST_ADDRESS);\n}\n}\n<span class=\"synStatement\">if<\/span> (text.length() &gt; <span class=\"synConstant\">0<\/span>) {\nMessage message = <span class=\"synStatement\">new<\/span> Message();\nmessage.setSubject(<span class=\"synConstant\">\"Twitter Timeline\"<\/span>);\nmessage.setTo(YOUR_MAIL);\nmessage.setSender(SYSTEM_ADMIN_MAIL);\nmessage.setTextBody(text.toString());\nMailServiceFactory.getMailService().send(message);\n}\n}\n}\n}\n<\/pre>\n\n<p>web.xml<\/p>\n\n<pre class=\"code lang-xml\" data-lang=\"xml\" data-unlink><span class=\"synIdentifier\">&lt;web-app&gt;<\/span>\n<span class=\"synIdentifier\">&lt;servlet&gt;<\/span>\n<span class=\"synIdentifier\">&lt;servlet-name&gt;<\/span>TwitterMail<span class=\"synIdentifier\">&lt;\/servlet-name&gt;<\/span>\n<span class=\"synIdentifier\">&lt;servlet-class&gt;<\/span>ishigami.TwitterMailServlet<span class=\"synIdentifier\">&lt;\/servlet-class&gt;<\/span>\n<span class=\"synIdentifier\">&lt;\/servlet&gt;<\/span>\n<span class=\"synIdentifier\">&lt;servlet-mapping&gt;<\/span>\n<span class=\"synIdentifier\">&lt;servlet-name&gt;<\/span>TwitterMail<span class=\"synIdentifier\">&lt;\/servlet-name&gt;<\/span>\n<span class=\"synIdentifier\">&lt;url-pattern&gt;<\/span>\/*<span class=\"synIdentifier\">&lt;\/url-pattern&gt;<\/span>\n<span class=\"synIdentifier\">&lt;\/servlet-mapping&gt;<\/span>\n<span class=\"synIdentifier\">&lt;\/web-app&gt;<\/span>\n<\/pre>\n\n<p>cron\u3067\u3001\u5b9a\u671f\u7684\u306b\"\/reply\"\u3092\u30ea\u30af\u30a8\u30b9\u30c8\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u3068\u304f\u3068\u3001<br \/>\n\u81ea\u5206\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6765\u305f\u3068\u304d\u306b\u643a\u5e2f\u306b\u30e1\u30fc\u30eb\u304c\u6765\u308b\u306e\u3067\u4fbf\u5229\u3067\u3059\u3002<\/p>\n\n<p>\u81ea\u5206\u7528\u306a\u306e\u3067\u3001\u8352\u524a\u308a\u3067\u3054\u3081\u3093\u306a\u3055\u3044\u3002<\/p>\n\n<p>\u53d6\u308a\u6271\u3044\u306b\u3064\u3044\u3066\u306f\u3001\u716e\u308b\u306a\u308a\u713c\u304f\u306a\u308a\u597d\u304d\u306b\u3057\u308d\u3067\u3059\u304c\u3001\u4fdd\u8a3c\u306f\u4e00\u5207\u3044\u305f\u3057\u307e\u305b\u3093\u3002<br \/>\n\u4f7f\u3044\u305f\u3044\u65b9\u306f\u81ea\u5206\u3067GAE\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u53d6\u5f97\u3057\u3066\u3001\u4e0a\u306e\u65b9\u306e\u5b9a\u6570\u306b\u9069\u5f53\u306a\u5024\u3092\u5165\u308c\u3066\u304f\u3060\u3055\u3044\u3002<\/p>\n\n<p>\u898b\u3066\u5206\u304b\u308b\u901a\u308a\u3001\u30bd\u30fc\u30b9\u306bID\u3068\u304b\u30d1\u30b9\u30ef\u30fc\u30c9\u3068\u304b\u3079\u305f\u66f8\u304d\u306a\u306e\u3067\u3001<br \/>\n\u305d\u3046\u8a00\u3046\u306e\u304c\u6c17\u306b\u5165\u3089\u306a\u3044\u4eba\u306f\u4f7f\u308f\u306a\u3044\u3088\u3046\u306b\u304a\u9858\u3044\u3057\u307e\u3059:D<\/p>\n<p style=\"margin-top: 0px; margin-bottom: 32px;>\n<script async src=\"\/\/pagead2.googlesyndication.com\/pagead\/js\/adsbygoogle.js\"><\/script>\n<ins class=\"adsbygoogle\"\n     style=\"display:inline-block;width:336px;height:280px\"\n     data-ad-client=\"ca-pub-4600091038664361\"\n     data-ad-slot=\"6658249733\"><\/ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n<\/script>\n<\/p>","protected":false},"excerpt":{"rendered":"<p>iPhone\u3082\u3001Android\u3082\u3001\u305d\u3082\u305d\u3082\u81ea\u5b85\u30cd\u30c3\u30c8\u74b0\u5883\u3082\u306a\u3044\u79c1\u306f\u3082\u3063\u3071\u3089\u3001\u643a\u5e2f\u3067Twitter\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002 tmitter\uff08http:\/\/tmitter.org\/\uff09\u3067\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u304c\u53d6\u5f97\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001G [&hellip;]<\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[42],"tags":[],"_links":{"self":[{"href":"https:\/\/www.susumuis.info\/index.php?rest_route=\/wp\/v2\/posts\/690"}],"collection":[{"href":"https:\/\/www.susumuis.info\/index.php?rest_route=\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/www.susumuis.info\/index.php?rest_route=\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/www.susumuis.info\/index.php?rest_route=\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/www.susumuis.info\/index.php?rest_route=%2Fwp%2Fv2%2Fcomments&post=690"}],"version-history":[{"count":2,"href":"https:\/\/www.susumuis.info\/index.php?rest_route=\/wp\/v2\/posts\/690\/revisions"}],"predecessor-version":[{"id":1053,"href":"https:\/\/www.susumuis.info\/index.php?rest_route=\/wp\/v2\/posts\/690\/revisions\/1053"}],"wp:attachment":[{"href":"https:\/\/www.susumuis.info\/index.php?rest_route=%2Fwp%2Fv2%2Fmedia&parent=690"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/www.susumuis.info\/index.php?rest_route=%2Fwp%2Fv2%2Fcategories&post=690"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/www.susumuis.info\/index.php?rest_route=%2Fwp%2Fv2%2Ftags&post=690"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}